{% extends "base.html" %}

{% block title %}Meus Agendamentos | AgendaPRO{% endblock %}

{% block content %}

<header class="mb-5">
    <h1 class="fw-light text-warning border-bottom border-warning pb-2">
        <i class="fas fa-calendar-check me-3" aria-hidden="true"></i>
        Seus Agendamentos
    </h1>
    <p class="lead text-pro-muted">
        Acompanhe seus serviços ativos, futuros e históricos.
    </p>
</header>

{% if agendamentos %}
<div class="row gy-4">

    {% for booking in agendamentos %}
        {# Lógica Jinja2: Define as classes e ícones com base no status #}
        {% set status_info = {
            'Pendente': {'border': 'border-info', 'badge': 'bg-info', 'icon': 'fas fa-hourglass-start'},
            'Confirmado': {'border': 'border-success', 'badge': 'bg-success', 'icon': 'fas fa-check-circle'},
            'Cancelado': {'border': 'border-danger', 'badge': 'bg-danger', 'icon': 'fas fa-times-circle'},
            'Concluído': {'border': 'border-secondary', 'badge': 'bg-secondary', 'icon': 'fas fa-calendar-day'}
        } %}
        {% set info = status_info.get(booking.status, status_info['Cancelado']) %}
        {% set data_formatada = booking.data_agendamento.strftime('%d/%m/%Y %H:%M') %}

        <div class="col-lg-6 col-md-12">

            <article class="card motion-card shadow-epic {{ info.border }} h-100">

                <div class="card-body d-flex flex-column p-4">

                    <h2 class="h5 fw-bold text-pro border-bottom border-secondary pb-2 mb-3">
                        <i class="fas fa-scissors me-2 text-warning" aria-hidden="true"></i>
                        {{ booking.servico.nome }}
                    </h2>

                    <dl class="small mb-4 text-pro-muted flex-grow-1">
                        
                        {# Data #}
                        <dt class="fw-bold text-warning mb-1">
                            <i class="fas fa-calendar-day me-2" aria-hidden="true"></i> Data:
                        </dt>
                        <dd class="text-pro ms-4 mb-2">
                            {{ booking.data_agendamento.strftime('%d/%m/%Y') }}
                        </dd>

                        {# Horário #}
                        <dt class="fw-bold text-warning mb-1">
                            <i class="fas fa-clock me-2" aria-hidden="true"></i> Horário:
                        </dt>
                        <dd class="text-pro ms-4 mb-2">
                            {{ booking.data_agendamento.strftime('%H:%M') }}
                        </dd>

                        {# Duração #}
                        <dt class="fw-bold text-warning mb-1">
                            <i class="fas fa-hourglass-half me-2" aria-hidden="true"></i> Duração:
                        </dt>
                        <dd class="text-pro ms-4 mb-0">
                            {{ booking.servico.duracao }} minutos
                        </dd>
                    </dl>

                    <footer class="d-flex justify-content-between align-items-center pt-3 border-top border-secondary mt-auto">

                        <span class="badge {{ info.badge }} fs-6 fw-bold">
                            <i class="{{ info.icon }} me-1" aria-hidden="true"></i>
                            {{ booking.status }}
                        </span>

                        <div class="d-flex gap-2">

                            {# CANCELAR: Apenas se Pendente E futuro #}
                            {% if booking.status == 'Pendente' and booking.data_agendamento >= hoje %}
                                <form method="POST"
                                        action="{{ url_for('client.cancel_booking', booking_id=booking.id) }}"
                                        onsubmit="return confirm('Deseja realmente cancelar o agendamento de {{ booking.servico.nome }} para {{ data_formatada }}?');">
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-warning fw-bold"
                                            aria-label="Cancelar agendamento de {{ booking.servico.nome }}">
                                        <i class="fas fa-ban me-1" aria-hidden="true"></i>
                                        Cancelar
                                    </button>
                                </form>
                            {% endif %}

                            {# EXCLUIR: Se Pendente, Cancelado ou Concluído #}
                            {% if booking.status in ['Pendente', 'Cancelado', 'Concluído'] %}
                                <form method="POST"
                                        action="{{ url_for('client.delete_booking', booking_id=booking.id) }}"
                                        onsubmit="return confirm('⚠️ Esta ação é irreversível. Deseja EXCLUIR definitivamente este agendamento?');">
                                    <button type="submit"
                                            class="btn btn-sm btn-outline-danger fw-bold"
                                            aria-label="Excluir definitivamente agendamento">
                                        <i class="fas fa-trash-alt me-1" aria-hidden="true"></i>
                                        Excluir
                                    </button>
                                </form>
                            {% endif %}
                        </div>

                    </footer>

                </div>
            </article>

        </div>
    {% endfor %}

</div>

{% else %}

<section class="alert alert-dark shadow-epic border-info text-center p-4" role="alert">
    <h3 class="alert-heading text-info">
        <i class="fas fa-calendar-xmark me-2" aria-hidden="true"></i>
        Nenhum agendamento encontrado
    </h3>

    <p class="text-pro-muted mb-4 lead">
        Você ainda não possui agendamentos ativos ou anteriores.
    </p>

    <a href="{{ url_for('client.index') }}"
        class="btn btn-warning fw-bold">
        <i class="fas fa-plus-circle me-2" aria-hidden="true"></i>
        Agendar um serviço
    </a>
</section>

{% endif %}

{% endblock %}