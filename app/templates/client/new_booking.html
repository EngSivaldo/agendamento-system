{% extends "base.html" %}

{% block title %}Agendar Serviço | AgendaPRO{% endblock %}

{% block content %}

<!-- HEADER -->
<header class="mb-5">
    <h1 class="fw-light text-warning border-bottom border-warning pb-2">
        <i class="fas fa-calendar-alt me-3"></i>
        Confirmação e Agendamento
    </h1>
    <p class="lead text-pro-muted">
        Escolha a data e o melhor horário para realizar seu serviço.
    </p>
</header>

<div class="card shadow-epic motion-card border border-secondary">
    <div class="card-body p-4 p-md-5">

        <!-- SERVIÇO -->
        <h3 class="mb-4 text-pro">
            Serviço Selecionado:
            <span class="text-info fw-bold">
                {{ service.nome if service else 'Carregando...' }}
            </span>
        </h3>

        <div class="row g-4">

            <!-- DETALHES -->
            <div class="col-lg-4">
                <div id="service-details"
                     data-service-id="{{ service.id }}"
                     class="bg-dark-pro rounded border border-secondary p-3 h-100">

                    <h5 class="text-warning mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Detalhes do Serviço
                    </h5>

                    <ul class="list-unstyled small text-pro-muted">
                        <li class="mb-2">
                            <i class="fas fa-clock me-2 text-warning"></i>
                            <strong>Duração:</strong>
                            {{ service.duracao if service else 'N/A' }} minutos
                        </li>

                        <li>
                            <i class="fas fa-hand-scissors me-2 text-warning"></i>
                            <strong>Descrição:</strong>
                            <span class="d-block mt-1">
                                {{ service.descricao if service else 'Descrição indisponível.' }}
                            </span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- AGENDAMENTO -->
            <div class="col-lg-8">

                <h5 class="mb-4 text-pro">
                    <i class="fas fa-tasks me-2 text-info"></i>
                    Processo de Reserva
                </h5>

                <!-- PROGRESSO -->
                <div class="progress mb-4" style="height: 8px;">
                    <div class="progress-bar bg-warning" style="width: 33%"></div>
                </div>

                <form method="POST"
                      action="{{ url_for('client.finalize_booking') }}"
                      id="booking-form">

                    <input type="hidden" name="service_id" value="{{ service.id }}">
                    <input type="hidden" name="datetime_slot" id="datetime_slot" required>

                    <!-- DATA -->
                    <h4 class="text-pro mb-3">
                        <i class="fas fa-calendar-day me-2 text-warning"></i>
                        1. Escolha a Data
                    </h4>

                    <div class="mb-4">
                        <input type="date"
                               class="form-control bg-dark text-pro border-secondary"
                               id="data_agendamento"
                               name="data_agendamento"
                               required>
                    </div>

                    <!-- HORÁRIOS -->
                    <h4 class="text-pro mt-4 mb-2">
                        <i class="fas fa-clock me-2 text-warning"></i>
                        2. Horários Disponíveis
                    </h4>

                    <p class="small text-pro-muted">
                        Clique em um horário para selecioná-lo.
                        Horários indisponíveis aparecem marcados com <strong>(X)</strong>.
                    </p>

                    <div id="available-slots-container"
                         class="bg-dark-pro rounded border border-secondary p-3 text-center text-pro-muted">
                        * Selecione uma data para visualizar os horários *
                    </div>

                    <!-- AÇÕES -->
                    <div class="mt-5 pt-4 border-top border-secondary">
                        <button type="submit"
                                id="finalize-button"
                                class="btn btn-success fw-bold me-3"
                                disabled>
                            <i class="fas fa-check-circle me-2"></i>
                            Finalizar Agendamento
                        </button>

                        <a href="{{ url_for('client.index') }}"
                           class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>
                            Voltar
                        </a>
                    </div>

                </form>

            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block scripts %}
<style>
.btn-slot-unavailable {
    background-color: #2b2b2b !important;
    color: #777 !important;
    border-color: #555 !important;
    cursor: not-allowed;
    text-decoration: line-through;
    opacity: 0.75;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {

    const dateInput = document.getElementById('data_agendamento');
    const slotsContainer = document.getElementById('available-slots-container');
    const serviceId = document.getElementById('service-details').dataset.serviceId;
    const datetimeInput = document.getElementById('datetime_slot');
    const finalizeBtn = document.getElementById('finalize-button');

    function selectSlot(e) {
        document.querySelectorAll('.slot-button:not(.btn-slot-unavailable)').forEach(btn => {
            btn.classList.remove('btn-warning');
            btn.classList.add('btn-outline-success');
        });

        const btn = e.currentTarget;
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-warning');

        datetimeInput.value = btn.dataset.datetime;
        finalizeBtn.disabled = false;
    }

    function loadSlots() {
        const date = dateInput.value;
        datetimeInput.value = '';
        finalizeBtn.disabled = true;

        if (!date) {
            slotsContainer.innerHTML = '* Selecione uma data para visualizar os horários *';
            return;
        }

        slotsContainer.innerHTML =
            '<p class="text-info"><i class="fas fa-spinner fa-spin me-2"></i> Carregando horários...</p>';

        fetch(`{{ url_for('client.available_slots') }}?service_id=${serviceId}&date=${date}`)
            .then(res => res.json())
            .then(data => {
                slotsContainer.innerHTML = '';

                if (!data.slots || data.slots.length === 0) {
                    slotsContainer.innerHTML =
                        '<p class="text-warning">Nenhum horário disponível para esta data.</p>';
                    return;
                }

                data.slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.classList.add('btn', 'm-2', 'slot-button');

                    if (slot.status === 'unavailable') {
                        btn.classList.add('btn-slot-unavailable');
                        btn.disabled = true;
                        btn.textContent = `${slot.time} (X)`;
                    } else {
                        btn.classList.add('btn-outline-success');
                        btn.dataset.datetime = slot.datetime_slot;
                        btn.textContent = slot.time;
                        btn.addEventListener('click', selectSlot);
                    }

                    slotsContainer.appendChild(btn);
                });
            })
            .catch(() => {
                slotsContainer.innerHTML =
                    '<p class="text-danger">Erro ao carregar horários.</p>';
            });
    }

    dateInput.addEventListener('change', loadSlots);
});
</script>
{% endblock %}
